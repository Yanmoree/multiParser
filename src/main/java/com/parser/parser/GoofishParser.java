package com.parser.parser;import com.parser.config.Config;import com.parser.model.Product;import com.parser.service.CookieService;import com.parser.util.HttpUtils;import org.apache.http.client.methods.HttpPost;import org.apache.http.entity.StringEntity;import org.apache.http.util.EntityUtils;import org.json.JSONArray;import org.json.JSONObject;import java.io.ByteArrayInputStream;import java.io.ByteArrayOutputStream;import java.nio.charset.StandardCharsets;import java.security.MessageDigest;import java.util.*;import java.util.regex.Matcher;import java.util.regex.Pattern;public class GoofishParser extends BaseParser {    private static final String SEARCH_ENDPOINT = "/h5/mtop.taobao.idlemtopsearch.pc.search/1.0/";    private static final String APP_KEY = "34839810";    private static final Pattern PUBLISHED_AGO_ZH = Pattern.compile("(\\d+)\\s*(分钟|小?时|天)前发布");    private static final Random random = new Random();    // Список User-Agent для ротации    private static final String[] USER_AGENTS = {            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",            "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/121.0",            "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",            "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",            "Mozilla/5.0 (iPhone; CPU iPhone OS 17_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.2 Mobile/15E148 Safari/604.1",            "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 YaBrowser/25.10.0.0 Safari/537.36"    };    public GoofishParser() {        super("goofish", "https://h5api.m.goofish.com");    }    @Override    protected String buildSearchUrl(String query, int page, int rows) {        return buildApiUrl(query, page, rows);    }    private String buildApiUrl(String query, int page, int rows) {        try {            long timestamp = System.currentTimeMillis();            String token = getTokenFromCookies();            if (token.isEmpty()) {                return "";            }            String dataStr = buildSearchData(query, page, rows);            String sign = generateSignature(token, timestamp, dataStr);            Map<String, String> params = new LinkedHashMap<>();            params.put("jsv", "2.7.2");            params.put("appKey", APP_KEY);            params.put("t", String.valueOf(timestamp));            params.put("sign", sign);            params.put("v", "1.0");            params.put("type", "originaljson");            params.put("accountSite", "xianyu");            params.put("dataType", "json");            params.put("timeout", "20000");            params.put("api", "mtop.taobao.idlemtopsearch.pc.search");            params.put("sessionOption", "AutoLoginOnly");            params.put("spm_cnt", "a21ybx.search.0.0");            params.put("spm_pre", "a21ybx.search.searchInput.0");            return HttpUtils.buildUrlWithParams(baseUrl + SEARCH_ENDPOINT, params);        } catch (Exception e) {            return "";        }    }    private String buildSearchData(String query, int page, int rows) {        JSONObject data = new JSONObject();        data.put("pageNumber", page);        data.put("keyword", query);        data.put("fromFilter", true);        data.put("rowsPerPage", rows);        data.put("sortValue", "desc");        data.put("sortField", "create");        data.put("customDistance", "");        data.put("gps", "");        JSONObject propValueStr = new JSONObject();        propValueStr.put("searchFilter", "");        data.put("propValueStr", propValueStr);        data.put("customGps", "");        data.put("searchReqFromPage", "pcSearch");        data.put("extraFilterValue", "{}");        data.put("userPositionJson", "{}");        return data.toString();    }    @Override    protected String executeSearchRequest(String url, String query, int page, int rows) throws Exception {        String dataStr = buildSearchData(query, page, rows);        String formData = "data=" + java.net.URLEncoder.encode(dataStr, "UTF-8");        HttpPost request = new HttpPost(url);        // Ротация User-Agent        String userAgent = USER_AGENTS[random.nextInt(USER_AGENTS.length)];        request.setHeader("User-Agent", userAgent);        request.setHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");        request.setHeader("Accept", "application/json");        request.setHeader("Accept-Encoding", "gzip, deflate, br, zstd");        request.setHeader("Accept-Language", "ru,en;q=0.9");        request.setHeader("Origin", "https://www.goofish.com");        request.setHeader("Referer", "https://www.goofish.com/");        request.setHeader("Sec-Fetch-Dest", "empty");        request.setHeader("Sec-Fetch-Mode", "cors");        request.setHeader("Sec-Fetch-Site", "same-site");        String domain = "h5api.m.goofish.com";        String cookieHeader = CookieService.getCookieHeader(domain);        if (cookieHeader != null && !cookieHeader.isEmpty()) {            request.setHeader("Cookie", cookieHeader);        }        request.setEntity(new StringEntity(formData, StandardCharsets.UTF_8));        try (var response = HttpUtils.getHttpClientInstance().execute(request)) {            int statusCode = response.getStatusLine().getStatusCode();            String contentType = response.getFirstHeader("Content-Type") != null ?                    response.getFirstHeader("Content-Type").getValue() : "unknown";            String contentEncoding = response.getFirstHeader("Content-Encoding") != null ?                    response.getFirstHeader("Content-Encoding").getValue() : "unknown";            byte[] responseBytes = EntityUtils.toByteArray(response.getEntity());            String responseBody;            if ("zstd".equalsIgnoreCase(contentEncoding)) {                responseBody = decompressZstd(responseBytes);            } else if ("gzip".equalsIgnoreCase(contentEncoding) || "deflate".equalsIgnoreCase(contentEncoding)) {                responseBody = new String(responseBytes, StandardCharsets.UTF_8);            } else {                responseBody = new String(responseBytes, StandardCharsets.UTF_8);            }            if (statusCode == 200) {                if (responseBody.trim().startsWith("{") || responseBody.trim().startsWith("[")) {                    return responseBody;                } else {                    throw new Exception("Ответ не в формате JSON: " + contentType);                }            } else {                throw new Exception("HTTP error: " + statusCode);            }        } catch (Exception e) {            throw e;        }    }    private String decompressZstd(byte[] compressedData) {        try {            byte[] decompressed = com.github.luben.zstd.Zstd.decompress(compressedData, 10 * 1024 * 1024);            return new String(decompressed, StandardCharsets.UTF_8);        } catch (Exception e) {            try {                String fallback = new String(compressedData, StandardCharsets.UTF_8);                return fallback;            } catch (Exception e2) {                return "Ошибка при обработке ответа: " + e.getMessage();            }        }    }    @Override    protected List<Product> parseResponse(String response, String query) {        List<Product> products = new ArrayList<>();        if (response == null || response.isEmpty()) {            return products;        }        try {            JSONObject json = new JSONObject(response);            if (json.has("ret")) {                String ret = json.optString("ret", "");                if (ret.contains("被挤爆啦") || ret.contains("RGV587_ERROR") ||                        ret.contains("FAIL_SYS_ILLEGAL_ACCESS")) {                    return products;                }            }            JSONObject data = json.optJSONObject("data");            if (data == null) {                return products;            }            JSONArray resultList = data.optJSONArray("resultList");            if (resultList == null || resultList.length() == 0) {                return products;            }            for (int i = 0; i < resultList.length(); i++) {                try {                    JSONObject item = resultList.getJSONObject(i);                    Product product = parseProductItem(item, query);                    if (product != null && isValidProduct(product)) {                        products.add(product);                    }                } catch (Exception e) {                    // Не логируем ошибки парсинга отдельных товаров                }            }        } catch (Exception e) {            // Не логируем ошибки парсинга        }        return products;    }    private Product parseProductItem(JSONObject item, String query) {        try {            JSONObject data = item.optJSONObject("data");            if (data == null) return null;            JSONObject itemObj = data.optJSONObject("item");            if (itemObj == null) return null;            JSONObject mainObj = itemObj.optJSONObject("main");            if (mainObj == null) return null;            JSONObject itemData = data.optJSONObject("itemData");            JSONObject exContent = mainObj.optJSONObject("exContent");            String itemId = null;            if (itemData != null) itemId = itemData.optString("itemId", "");            if ((itemId == null || itemId.isEmpty()) && exContent != null) {                itemId = exContent.optString("itemId", "");            }            if (itemId == null || itemId.isEmpty()) return null;            Product product = new Product();            product.setId(itemId);            product.setSite("goofish");            product.setQuery(query);            String title = "";            if (itemData != null) {                title = itemData.optString("title", "");            }            if ((title == null || title.isEmpty()) && exContent != null) {                title = exContent.optString("title", "");            }            if ((title == null || title.isEmpty()) && mainObj != null) {                JSONObject clickParam = mainObj.optJSONObject("clickParam");                if (clickParam != null) {                    JSONObject args = clickParam.optJSONObject("args");                    if (args != null) {                        title = args.optString("subject", "");                    }                }            }            if (title != null && title.length() > 150) {                title = title.substring(0, 147) + "...";            }            if (title == null || title.isEmpty() || "No title".equals(title) || "null".equals(title)) {                title = "Товар #" + itemId + " (" + query + ")";            }            product.setTitle(title);            double price = extractPrice(itemData, exContent);            product.setPrice(price);            long publishTime = extractPublishTime(mainObj, itemData, exContent);            int ageMinutes = calculateAge(publishTime);            Integer ageFromTags = extractAgeMinutesFromTags(exContent, mainObj);            if (ageFromTags != null) {                if (publishTime <= 0 || ageMinutes <= 0 || ageMinutes > 10080) {                    ageMinutes = ageFromTags;                } else {                    if (Math.abs(ageMinutes - ageFromTags) > 60) {                        ageMinutes = ageFromTags;                    }                }            }            product.setAgeMinutes(ageMinutes);            String location = itemData != null ? itemData.optString("area", "") : "";            product.setLocation(location.isEmpty() ? "Не указано" : location);            product.setUrl("https://www.goofish.com/item?id=" + itemId);            List<String> images = extractImages(mainObj, itemObj, data);            product.setImages(images);            return product;        } catch (Exception e) {            return null;        }    }    private double extractPrice(JSONObject itemData, JSONObject exContent) {        if (itemData != null) {            Object priceObj = itemData.opt("price");            if (priceObj != null) return parsePrice(priceObj);        }        if (exContent != null) {            Object priceObj = exContent.opt("price");            if (priceObj != null) return parsePrice(priceObj);        }        return 0.0;    }    private double parsePrice(Object priceObj) {        if (priceObj instanceof String) {            return extractPrice((String) priceObj);        }        if (priceObj instanceof Number) {            return ((Number) priceObj).doubleValue();        }        if (priceObj instanceof JSONArray) {            JSONArray arr = (JSONArray) priceObj;            StringBuilder sb = new StringBuilder();            for (int i = 0; i < arr.length(); i++) {                JSONObject part = arr.optJSONObject(i);                if (part != null && "integer".equals(part.optString("type"))) {                    sb.append(part.optString("text"));                }            }            return extractPrice(sb.toString());        }        return 0.0;    }    public double extractPrice(String priceStr) {        if (priceStr == null || priceStr.isEmpty()) return 0.0;        try {            String clean = priceStr.replaceAll("[^\\d.,]", "").replace(',', '.');            return Double.parseDouble(clean);        } catch (NumberFormatException e) {            return 0.0;        }    }    private long extractPublishTime(JSONObject main, JSONObject itemData, JSONObject exContent) {        if (main != null) {            JSONObject clickParam = main.optJSONObject("clickParam");            if (clickParam != null) {                JSONObject args = clickParam.optJSONObject("args");                if (args != null && args.has("publishTime")) {                    Object time = args.opt("publishTime");                    if (time instanceof String) return Long.parseLong((String) time);                    if (time instanceof Number) return ((Number) time).longValue();                }            }        }        if (itemData != null && itemData.has("publishTime")) {            Object time = itemData.opt("publishTime");            if (time instanceof String) return Long.parseLong((String) time);            if (time instanceof Number) return ((Number) time).longValue();        }        return 0;    }    private Integer extractAgeMinutesFromTags(JSONObject exContent, JSONObject mainObj) {        try {            if (mainObj != null) {                JSONObject clickParam = mainObj.optJSONObject("clickParam");                if (clickParam != null) {                    JSONObject args = clickParam.optJSONObject("args");                    if (args != null) {                        String serviceUtParams = args.optString("serviceUtParams", "");                        Integer parsed = parseAgeMinutesFromText(serviceUtParams);                        if (parsed != null) return parsed;                    }                }            }            if (exContent != null) {                JSONObject fishTags = exContent.optJSONObject("fishTags");                if (fishTags != null) {                    JSONObject r2 = fishTags.optJSONObject("r2");                    if (r2 != null) {                        JSONArray tagList = r2.optJSONArray("tagList");                        if (tagList != null) {                            for (int i = 0; i < Math.min(5, tagList.length()); i++) {                                JSONObject tag = tagList.optJSONObject(i);                                if (tag == null) continue;                                JSONObject data = tag.optJSONObject("data");                                if (data == null) continue;                                String content = data.optString("content", "");                                Integer parsed = parseAgeMinutesFromText(content);                                if (parsed != null) return parsed;                            }                        }                    }                }            }        } catch (Exception ignored) {        }        return null;    }    private Integer parseAgeMinutesFromText(String text) {        if (text == null || text.isEmpty()) return null;        Matcher m = PUBLISHED_AGO_ZH.matcher(text);        if (!m.find()) return null;        int value;        try {            value = Integer.parseInt(m.group(1));        } catch (NumberFormatException e) {            return null;        }        String unit = m.group(2);        if (unit.contains("分钟")) return Math.max(1, value);        if (unit.contains("时")) return Math.max(1, value * 60);        if (unit.contains("天")) return Math.max(1, value * 24 * 60);        return null;    }    private int calculateAge(long publishTime) {        if (publishTime <= 0) return 0;        if (publishTime < 10000000000L) {            publishTime = publishTime * 1000;        }        long ageMs = System.currentTimeMillis() - publishTime;        int ageMinutes = (int) (ageMs / (1000 * 60));        return Math.max(1, Math.min(ageMinutes, 10080));    }    private List<String> extractImages(JSONObject main, JSONObject itemObj, JSONObject data) {        List<String> images = new ArrayList<>();        if (data != null && data.has("picUrl")) {            String picUrl = data.optString("picUrl", "");            if (isValidImageUrl(picUrl)) {                images.add(picUrl);            }        }        if (data != null && data.has("pics")) {            JSONArray pics = data.optJSONArray("pics");            if (pics != null) {                for (int i = 0; i < Math.min(5, pics.length()); i++) {                    try {                        JSONObject pic = pics.optJSONObject(i);                        if (pic != null) {                            String url = pic.optString("picUrl", "");                            if (url.isEmpty()) {                                url = pic.optString("pic_url", "");                            }                            if (url.isEmpty()) {                                url = pic.optString("url", "");                            }                            if (isValidImageUrl(url) && !images.contains(url)) {                                images.add(url);                            }                        }                    } catch (Exception e) {                    }                }            }        }        if (itemObj != null) {            JSONObject extra = itemObj.optJSONObject("extra");            if (extra != null) {                String picUrl = extra.optString("picUrl", "");                if (picUrl.isEmpty()) {                    picUrl = extra.optString("pic_url", "");                }                if (isValidImageUrl(picUrl) && !images.contains(picUrl)) {                    images.add(picUrl);                }            }        }        if (main != null) {            JSONObject exContent = main.optJSONObject("exContent");            if (exContent != null) {                String picUrl = exContent.optString("picUrl", "");                if (picUrl.isEmpty()) {                    picUrl = exContent.optString("pic_url", "");                }                if (isValidImageUrl(picUrl) && !images.contains(picUrl)) {                    images.add(picUrl);                }            }        }        if (data != null) {            String directPic = data.optString("image", "");            if (directPic.isEmpty()) {                directPic = data.optString("img", "");            }            if (isValidImageUrl(directPic) && !images.contains(directPic)) {                images.add(directPic);            }        }        return images;    }    private boolean isValidImageUrl(String url) {        if (url == null || url.isEmpty()) {            return false;        }        if (!url.startsWith("http://") && !url.startsWith("https://")) {            return false;        }        String lowerUrl = url.toLowerCase();        String[] validExtensions = {".jpg", ".jpeg", ".png", ".gif", ".webp", ".heic"};        boolean hasValidExtension = false;        for (String ext : validExtensions) {            if (lowerUrl.contains(ext)) {                hasValidExtension = true;                break;            }        }        if (!hasValidExtension && (lowerUrl.contains("alicdn") || lowerUrl.contains("taobaocdn"))) {            return true;        }        return hasValidExtension;    }    private boolean isValidProduct(Product product) {        return product.getId() != null && !product.getId().isEmpty() &&                product.getTitle() != null && !product.getTitle().isEmpty() &&                product.getUrl() != null && !product.getUrl().isEmpty();    }    private String getTokenFromCookies() {        try {            String cookies = CookieService.getCookieHeader("h5api.m.goofish.com");            if (cookies == null || cookies.isEmpty()) return "";            String[] pairs = cookies.split("; ");            for (String pair : pairs) {                if (pair.startsWith("_m_h5_tk=")) {                    String mh5tk = pair.substring(9);                    if (mh5tk.contains("_")) {                        return mh5tk.split("_")[0];                    }                }            }        } catch (Exception e) {        }        return "";    }    private String generateSignature(String token, long timestamp, String data) {        try {            String signString = token + "&" + timestamp + "&" + APP_KEY + "&" + data;            MessageDigest md = MessageDigest.getInstance("MD5");            byte[] hash = md.digest(signString.getBytes(StandardCharsets.UTF_8));            StringBuilder hex = new StringBuilder();            for (byte b : hash) {                String h = Integer.toHexString(0xff & b);                if (h.length() == 1) hex.append('0');                hex.append(h);            }            return hex.toString();        } catch (Exception e) {            return "";        }    }    @Override    public List<Product> search(String query, int maxPages, int rowsPerPage, int maxAgeMinutes) {        List<Product> allProducts = new ArrayList<>();        for (int page = 1; page <= maxPages; page++) {            if (Thread.currentThread().isInterrupted()) break;            try {                String url = buildSearchUrl(query, page, rowsPerPage);                if (url.isEmpty()) {                    break;                }                String response = executeSearchRequest(url, query, page, rowsPerPage);                totalRequests++;                List<Product> products = parseResponse(response, query);                if (products.isEmpty()) {                    break;                }                List<Product> filtered = new ArrayList<>();                for (Product p : products) {                    if (p.getAgeMinutes() <= maxAgeMinutes) {                        filtered.add(p);                    }                }                allProducts.addAll(filtered);                if (products.size() < rowsPerPage) break;                int delay = getRequestDelay();                if (delay > 0 && page < maxPages) {                    Thread.sleep(delay);                }            } catch (Exception e) {                failedRequests++;                if (shouldStopOnError(e)) break;                try {                    Thread.sleep(3000);                } catch (InterruptedException ie) {                    Thread.currentThread().interrupt();                    break;                }            }        }        return allProducts;    }}