package com.parser.parser;import com.parser.config.Config;import com.parser.model.Product;import com.parser.service.CookieService;import com.parser.util.HttpUtils;import org.apache.http.client.methods.HttpPost;import org.apache.http.entity.StringEntity;import org.apache.http.util.EntityUtils;import org.json.JSONArray;import org.json.JSONObject;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import java.io.ByteArrayInputStream;import java.io.ByteArrayOutputStream;import java.nio.charset.StandardCharsets;import java.security.MessageDigest;import java.util.*;import java.util.regex.Matcher;import java.util.regex.Pattern;/** * –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –¥–ª—è Goofish —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º POST –∑–∞–ø—Ä–æ—Å–æ–º –∏ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π zstd */public class GoofishParser extends BaseParser {    private static final Logger logger = LoggerFactory.getLogger(GoofishParser.class);    private static final String SEARCH_ENDPOINT = "/h5/mtop.taobao.idlemtopsearch.pc.search/1.0/";    private static final String APP_KEY = "34839810";    private static final Pattern PUBLISHED_AGO_ZH = Pattern.compile("(\\d+)\\s*(ÂàÜÈíü|Â∞è?Êó∂|Â§©)ÂâçÂèëÂ∏É");    private static final Random random = new Random();    private static long lastRequestTime = 0;    public GoofishParser() {        super("goofish", "https://h5api.m.goofish.com");    }    @Override    protected String buildSearchUrl(String query, int page, int rows) {        // –î–ª—è POST –∑–∞–ø—Ä–æ—Å–∞ URL —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ data        return buildApiUrl(query, page, rows);    }    /**     * –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ URL API     */    private String buildApiUrl(String query, int page, int rows) {        try {            long timestamp = System.currentTimeMillis();            String token = getTokenFromCookies();            if (token.isEmpty()) {                logger.error("‚ùå Token is empty! Check cookies");                return "";            }            // –§–æ—Ä–º–∏—Ä—É–µ–º data –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –ø–æ–¥–ø–∏—Å–∏            String dataStr = buildSearchData(query, page, rows);            String sign = generateSignature(token, timestamp, dataStr);            // –°—Ç—Ä–æ–∏–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∫–∞–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ            Map<String, String> params = new LinkedHashMap<>();            params.put("jsv", "2.7.2");            params.put("appKey", APP_KEY);            params.put("t", String.valueOf(timestamp));            params.put("sign", sign);            params.put("v", "1.0");            params.put("type", "originaljson");            params.put("accountSite", "xianyu");            params.put("dataType", "json");            params.put("timeout", "20000");            params.put("api", "mtop.taobao.idlemtopsearch.pc.search");            params.put("sessionOption", "AutoLoginOnly");            params.put("spm_cnt", "a21ybx.search.0.0");            params.put("spm_pre", "a21ybx.search.searchInput.0");            return HttpUtils.buildUrlWithParams(baseUrl + SEARCH_ENDPOINT, params);        } catch (Exception e) {            logger.error("Error building URL: {}", e.getMessage());            return "";        }    }    /**     * –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–∏—Å–∫–∞     */    private String buildSearchData(String query, int page, int rows) {        JSONObject data = new JSONObject();        data.put("pageNumber", page);        data.put("keyword", query);        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–ø—Ä–æ—Å–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∞–º—ã–µ –Ω–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã –ø–µ—Ä–≤—ã–º–∏        data.put("fromFilter", true);        data.put("rowsPerPage", rows);        data.put("sortValue", "desc");        data.put("sortField", "create");        data.put("customDistance", "");        data.put("gps", "");        JSONObject propValueStr = new JSONObject();        propValueStr.put("searchFilter", "");        data.put("propValueStr", propValueStr);        data.put("customGps", "");        data.put("searchReqFromPage", "pcSearch");        data.put("extraFilterValue", "{}");        data.put("userPositionJson", "{}");        return data.toString();    }    /**     * –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è POST –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ zstd     */    @Override    protected String executeSearchRequest(String url, String query, int page, int rows) throws Exception {        // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞        String dataStr = buildSearchData(query, page, rows);        String formData = "data=" + java.net.URLEncoder.encode(dataStr, "UTF-8");        logger.info("üì§ POST –∑–∞–ø—Ä–æ—Å –∫: {}", url);        logger.debug("üìù –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞: {}", formData);        // –°–æ–∑–¥–∞–µ–º POST –∑–∞–ø—Ä–æ—Å        HttpPost request = new HttpPost(url);        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–∞–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ        request.setHeader("User-Agent", "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 YaBrowser/25.10.0.0 Safari/537.36");        request.setHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");        request.setHeader("Accept", "application/json");        request.setHeader("Accept-Encoding", "gzip, deflate, br, zstd");        request.setHeader("Accept-Language", "ru,en;q=0.9");        request.setHeader("Origin", "https://www.goofish.com");        request.setHeader("Referer", "https://www.goofish.com/");        request.setHeader("Sec-Fetch-Dest", "empty");        request.setHeader("Sec-Fetch-Mode", "cors");        request.setHeader("Sec-Fetch-Site", "same-site");        request.setHeader("sec-ch-ua", "\"Chromium\";v=\"140\", \"Not=A?Brand\";v=\"24\", \"YaBrowser\";v=\"25.10\", \"Yowser\";v=\"2.5\", \"YaBrowserCorp\";v=\"140\"");        request.setHeader("sec-ch-ua-mobile", "?0");        request.setHeader("sec-ch-ua-platform", "\"macOS\"");        request.setHeader("x-accept-terminal", "pc");        // –î–æ–±–∞–≤–ª—è–µ–º –∫—É–∫–∏        String domain = "h5api.m.goofish.com";        String cookieHeader = CookieService.getCookieHeader(domain);        if (cookieHeader != null && !cookieHeader.isEmpty()) {            request.setHeader("Cookie", cookieHeader);            logger.debug("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∫—É–∫–∏: {} —Å–∏–º–≤–æ–ª–æ–≤", cookieHeader.length());        } else {            logger.warn("‚ö†Ô∏è –ö—É–∫–∏ –ø—É—Å—Ç—ã–µ!");        }        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞        request.setEntity(new StringEntity(formData, StandardCharsets.UTF_8));        // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å        try (var response = HttpUtils.getHttpClientInstance().execute(request)) {            int statusCode = response.getStatusLine().getStatusCode();            String contentType = response.getFirstHeader("Content-Type") != null ?                    response.getFirstHeader("Content-Type").getValue() : "unknown";            String contentEncoding = response.getFirstHeader("Content-Encoding") != null ?                    response.getFirstHeader("Content-Encoding").getValue() : "unknown";            logger.info("üì• –û—Ç–≤–µ—Ç: —Å—Ç–∞—Ç—É—Å={}, content-type={}, content-encoding={}",                    statusCode, contentType, contentEncoding);            // –ü–æ–ª—É—á–∞–µ–º —Å—ã—Ä—ã–µ –±–∞–π—Ç—ã –æ—Ç–≤–µ—Ç–∞            byte[] responseBytes = EntityUtils.toByteArray(response.getEntity());            String responseBody;            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–∂–∞—Ç–∏–µ            if ("zstd".equalsIgnoreCase(contentEncoding)) {                logger.info("üîÑ –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º zstd —Å–∂–∞—Ç–∏–µ...");                responseBody = decompressZstd(responseBytes);            } else if ("gzip".equalsIgnoreCase(contentEncoding) || "deflate".equalsIgnoreCase(contentEncoding)) {                // HttpClient –æ–±—ã—á–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç gzip/deflate                responseBody = new String(responseBytes, StandardCharsets.UTF_8);            } else {                // –ë–µ–∑ —Å–∂–∞—Ç–∏—è                responseBody = new String(responseBytes, StandardCharsets.UTF_8);            }            // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏            org.apache.http.Header[] headers = response.getAllHeaders();            logger.debug("üìã –ó–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞:");            for (org.apache.http.Header header : headers) {                if (header.getName().equalsIgnoreCase("Set-Cookie") ||                        header.getName().equalsIgnoreCase("Content-Type") ||                        header.getName().equalsIgnoreCase("Content-Encoding") ||                        header.getName().equalsIgnoreCase("X-EagleEye-Id")) {                    logger.debug("   {}: {}", header.getName(), header.getValue());                }            }            logger.debug("üìÑ –¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ (–ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤): {}",                    responseBody.length() > 500 ? responseBody.substring(0, 500) + "..." : responseBody);            if (statusCode == 200) {                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ JSON –∏–ª–∏ —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ                if (responseBody.trim().startsWith("{") || responseBody.trim().startsWith("[")) {                    logger.info("‚úÖ –ü–æ–ª—É—á–µ–Ω JSON –æ—Ç–≤–µ—Ç, –¥–ª–∏–Ω–∞: {} —Å–∏–º–≤–æ–ª–æ–≤", responseBody.length());                    return responseBody;                } else {                    logger.error("‚ùå –û—Ç–≤–µ—Ç –Ω–µ JSON. –ü–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤: {}",                            responseBody.length() > 200 ? responseBody.substring(0, 200) : responseBody);                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ –ª–∏ –º—ã HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –æ—à–∏–±–∫–æ–π                    if (responseBody.contains("<html") || responseBody.contains("<!DOCTYPE")) {                        logger.error("‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω–∞ HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–º–µ—Å—Ç–æ JSON. –í–æ–∑–º–æ–∂–Ω–æ, –∫—É–∫–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã.");                    } else if (responseBody.contains("Ë¢´Êå§ÁàÜÂï¶") || responseBody.contains("FAIL_SYS_ILLEGAL_ACCESS")) {                        logger.error("‚ö†Ô∏è API –≤–µ—Ä–Ω—É–ª–æ –æ—à–∏–±–∫—É: {}",                                responseBody.length() > 100 ? responseBody.substring(0, 100) : responseBody);                    }                    throw new Exception("–û—Ç–≤–µ—Ç –Ω–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON: " + contentType);                }            } else {                logger.error("‚ùå HTTP –æ—à–∏–±–∫–∞ {}: {}", statusCode,                        responseBody.length() > 200 ? responseBody.substring(0, 200) + "..." : responseBody);                throw new Exception("HTTP error: " + statusCode);            }        } catch (Exception e) {            logger.error("‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞: {}", e.getMessage());            throw e;        }    }    /**     * –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ zstd —Å–∂–∞—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö     */    private String decompressZstd(byte[] compressedData) {        try {            logger.debug("üì¶ –†–∞–∑–º–µ—Ä —Å–∂–∞—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö: {} –±–∞–π—Ç", compressedData.length);            // –ò—Å–ø–æ–ª—å–∑—É–µ–º zstd-jni –¥–ª—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏            byte[] decompressed = com.github.luben.zstd.Zstd.decompress(compressedData, 10 * 1024 * 1024); // –ú–∞–∫—Å 10MB            String result = new String(decompressed, StandardCharsets.UTF_8);            logger.debug("‚úÖ Zstd —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω");            logger.debug("üìÑ –†–∞–∑–º–µ—Ä —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: {} —Å–∏–º–≤–æ–ª–æ–≤", result.length());            return result;        } catch (Exception e) {            logger.error("‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏ zstd: {}", e.getMessage());            // –ü—Ä–æ–±—É–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–∞–∫ –æ–±—ã—á–Ω—É—é —Å—Ç—Ä–æ–∫—É            try {                String fallback = new String(compressedData, StandardCharsets.UTF_8);                logger.warn("‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback —á—Ç–µ–Ω–∏–µ –∫–∞–∫ UTF-8");                return fallback;            } catch (Exception e2) {                return "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞: " + e.getMessage();            }        }    }    // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π    @Override    protected List<Product> parseResponse(String response, String query) {        List<Product> products = new ArrayList<>();        if (response == null || response.isEmpty()) {            logger.warn("Empty response");            return products;        }        try {            JSONObject json = new JSONObject(response);            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ—à–∏–±–æ–∫            if (json.has("ret")) {                String ret = json.optString("ret", "");                if (ret.contains("Ë¢´Êå§ÁàÜÂï¶") || ret.contains("RGV587_ERROR") ||                        ret.contains("FAIL_SYS_ILLEGAL_ACCESS")) {                    logger.error("API error: {}", ret);                    return products;                }            }            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ            JSONObject data = json.optJSONObject("data");            if (data == null) {                logger.warn("No data in response");                return products;            }            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤            JSONArray resultList = data.optJSONArray("resultList");            if (resultList == null || resultList.length() == 0) {                logger.debug("No items found in response");                return products;            }            logger.info("Found {} items", resultList.length());            for (int i = 0; i < resultList.length(); i++) {                try {                    JSONObject item = resultList.getJSONObject(i);                    Product product = parseProductItem(item, query);                    if (product != null && isValidProduct(product)) {                        products.add(product);                    }                } catch (Exception e) {                    logger.debug("Error parsing item {}: {}", i, e.getMessage());                }            }            logger.info("Successfully parsed {} products", products.size());        } catch (Exception e) {            logger.error("Error parsing response: {}", e.getMessage());            logger.debug("Response content (first 500 chars): {}",                    response.length() > 500 ? response.substring(0, 500) + "..." : response);        }        return products;    }    private Product parseProductItem(JSONObject item, String query) {        try {            JSONObject data = item.optJSONObject("data");            if (data == null) return null;            JSONObject itemObj = data.optJSONObject("item");            if (itemObj == null) return null;            JSONObject mainObj = itemObj.optJSONObject("main");            if (mainObj == null) return null;            JSONObject itemData = data.optJSONObject("itemData");            JSONObject exContent = mainObj.optJSONObject("exContent");            // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ ID —Ç–æ–≤–∞—Ä–∞            String itemId = null;            if (itemData != null) itemId = itemData.optString("itemId", "");            if ((itemId == null || itemId.isEmpty()) && exContent != null) {                itemId = exContent.optString("itemId", "");            }            if (itemId == null || itemId.isEmpty()) return null;            Product product = new Product();            product.setId(itemId);            product.setSite("goofish");            product.setQuery(query);            // üî¥ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–ê–†–°–ò–ù–ì –ù–ê–ó–í–ê–ù–ò–Ø            String title = "";            // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–∞–∑–≤–∞–Ω–∏—è            if (itemData != null) {                title = itemData.optString("title", "");                if (title.isEmpty()) {                    title = itemData.optString("text", "");                }                if (title.isEmpty()) {                    title = itemData.optString("name", "");                }            }            if (title.isEmpty() && exContent != null) {                title = exContent.optString("title", "");                if (title.isEmpty()) {                    title = exContent.optString("text", "");                }                if (title.isEmpty()) {                    title = exContent.optString("name", "");                }            }            if (title.isEmpty() && mainObj != null) {                JSONObject clickParam = mainObj.optJSONObject("clickParam");                if (clickParam != null) {                    JSONObject args = clickParam.optJSONObject("args");                    if (args != null) {                        title = args.optString("subject", "");                    }                }            }            // –ï—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –ø—É—Å—Ç–æ–µ, —Å–æ–∑–¥–∞–µ–º –±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ            if (title.isEmpty()) {                title = "–¢–æ–≤–∞—Ä #" + itemId + " (" + query + ")";            }            product.setTitle(title);            // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...            // –¶–µ–Ω–∞            double price = extractPrice(itemData, exContent);            product.setPrice(price);            // –í–æ–∑—Ä–∞—Å—Ç —Ç–æ–≤–∞—Ä–∞            long publishTime = extractPublishTime(mainObj, itemData, exContent);            int ageMinutes = calculateAge(publishTime);            // –ï—Å–ª–∏ publishTime —Å—Ç—Ä–∞–Ω–Ω—ã–π/–ø—É—Å—Ç–æ–π, –ø—Ä–æ–±—É–µ–º –≤—ã—Ç–∞—â–∏—Ç—å –≤–æ–∑—Ä–∞—Å—Ç –∏–∑ –º–µ—Ç–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä "6Â∞èÊó∂ÂâçÂèëÂ∏É")            Integer ageFromTags = extractAgeMinutesFromTags(exContent, mainObj);            if (ageFromTags != null) {                // –ï—Å–ª–∏ publishTime –Ω–µ –¥–∞–ª –∞–¥–µ–∫–≤–∞—Ç–Ω–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–∫—É                if (publishTime <= 0 || ageMinutes <= 0 || ageMinutes > 10080) {                    ageMinutes = ageFromTags;                } else {                    // –ò–Ω–æ–≥–¥–∞ publishTime –±—ã–≤–∞–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–º: –µ—Å–ª–∏ –º–µ—Ç–∫–∞ —Å–∏–ª—å–Ω–æ —Ä–∞—Å—Ö–æ–¥–∏—Ç—Å—è, –¥–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–∫–µ                    if (Math.abs(ageMinutes - ageFromTags) > 60) {                        ageMinutes = ageFromTags;                    }                }            }            product.setAgeMinutes(ageMinutes);            // –õ–æ–∫–∞—Ü–∏—è            String location = itemData != null ? itemData.optString("area", "") : "";            product.setLocation(location.isEmpty() ? "–ù–µ —É–∫–∞–∑–∞–Ω–æ" : location);            // URL - —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π            product.setUrl("https://www.goofish.com/item?id=" + itemId);            // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è            List<String> images = extractImages(mainObj, itemObj, data);            product.setImages(images);            logger.debug("Parsed: {} ({}¬•, {}min, {} images)",                    product.getShortTitle(), price, ageMinutes, images.size());            return product;        } catch (Exception e) {            logger.error("Error parsing product item: {}", e.getMessage());            return null;        }    }    private double extractPrice(JSONObject itemData, JSONObject exContent) {        if (itemData != null) {            Object priceObj = itemData.opt("price");            if (priceObj != null) return parsePrice(priceObj);        }        if (exContent != null) {            Object priceObj = exContent.opt("price");            if (priceObj != null) return parsePrice(priceObj);        }        return 0.0;    }    private double parsePrice(Object priceObj) {        if (priceObj instanceof String) {            return extractPrice((String) priceObj);        }        if (priceObj instanceof Number) {            return ((Number) priceObj).doubleValue();        }        if (priceObj instanceof JSONArray) {            JSONArray arr = (JSONArray) priceObj;            StringBuilder sb = new StringBuilder();            for (int i = 0; i < arr.length(); i++) {                JSONObject part = arr.optJSONObject(i);                if (part != null && "integer".equals(part.optString("type"))) {                    sb.append(part.optString("text"));                }            }            return extractPrice(sb.toString());        }        return 0.0;    }    public double extractPrice(String priceStr) {        if (priceStr == null || priceStr.isEmpty()) return 0.0;        try {            String clean = priceStr.replaceAll("[^\\d.,]", "").replace(',', '.');            return Double.parseDouble(clean);        } catch (NumberFormatException e) {            return 0.0;        }    }    private long extractPublishTime(JSONObject main, JSONObject itemData, JSONObject exContent) {        // –ü—É—Ç—å 1: args.publishTime        if (main != null) {            JSONObject clickParam = main.optJSONObject("clickParam");            if (clickParam != null) {                JSONObject args = clickParam.optJSONObject("args");                if (args != null && args.has("publishTime")) {                    Object time = args.opt("publishTime");                    if (time instanceof String) return Long.parseLong((String) time);                    if (time instanceof Number) return ((Number) time).longValue();                }            }        }        // –ü—É—Ç—å 2: itemData.publishTime        if (itemData != null && itemData.has("publishTime")) {            Object time = itemData.opt("publishTime");            if (time instanceof String) return Long.parseLong((String) time);            if (time instanceof Number) return ((Number) time).longValue();        }        return 0;    }    /**     * –ü—ã—Ç–∞–µ—Ç—Å—è –∏–∑–≤–ª–µ—á—å "–≤–æ–∑—Ä–∞—Å—Ç" –∏–∑ UI-–º–µ—Ç–æ–∫ –≤ –æ—Ç–≤–µ—Ç–µ (—á–∞—Å—Ç–æ —Ç–∞–º –µ—Å—Ç—å —Å—Ç—Ä–æ–∫–∞ –≤–∏–¥–∞ "6Â∞èÊó∂ÂâçÂèëÂ∏É").     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç –≤ –º–∏–Ω—É—Ç–∞—Ö –∏–ª–∏ null, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å.     */    private Integer extractAgeMinutesFromTags(JSONObject exContent, JSONObject mainObj) {        try {            // –ü—É—Ç—å 1: mainObj.clickParam.args.serviceUtParams (—Å—Ç—Ä–æ–∫–∞ JSON —Å content)            if (mainObj != null) {                JSONObject clickParam = mainObj.optJSONObject("clickParam");                if (clickParam != null) {                    JSONObject args = clickParam.optJSONObject("args");                    if (args != null) {                        String serviceUtParams = args.optString("serviceUtParams", "");                        Integer parsed = parseAgeMinutesFromText(serviceUtParams);                        if (parsed != null) return parsed;                    }                }            }            // –ü—É—Ç—å 2: exContent.fishTags.r2.tagList[*].data.content            if (exContent != null) {                JSONObject fishTags = exContent.optJSONObject("fishTags");                if (fishTags != null) {                    JSONObject r2 = fishTags.optJSONObject("r2");                    if (r2 != null) {                        JSONArray tagList = r2.optJSONArray("tagList");                        if (tagList != null) {                            for (int i = 0; i < Math.min(5, tagList.length()); i++) {                                JSONObject tag = tagList.optJSONObject(i);                                if (tag == null) continue;                                JSONObject data = tag.optJSONObject("data");                                if (data == null) continue;                                String content = data.optString("content", "");                                Integer parsed = parseAgeMinutesFromText(content);                                if (parsed != null) return parsed;                            }                        }                    }                }            }        } catch (Exception ignored) {        }        return null;    }    private Integer parseAgeMinutesFromText(String text) {        if (text == null || text.isEmpty()) return null;        Matcher m = PUBLISHED_AGO_ZH.matcher(text);        if (!m.find()) return null;        int value;        try {            value = Integer.parseInt(m.group(1));        } catch (NumberFormatException e) {            return null;        }        String unit = m.group(2);        if (unit.contains("ÂàÜÈíü")) return Math.max(1, value);        if (unit.contains("Êó∂")) return Math.max(1, value * 60);        if (unit.contains("Â§©")) return Math.max(1, value * 24 * 60);        return null;    }    private int calculateAge(long publishTime) {        if (publishTime <= 0) return 0;        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ (—Å–µ–∫—É–Ω–¥—ã –∏–ª–∏ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã)        if (publishTime < 10000000000L) {            publishTime = publishTime * 1000;        }        long ageMs = System.currentTimeMillis() - publishTime;        int ageMinutes = (int) (ageMs / (1000 * 60));        return Math.max(1, Math.min(ageMinutes, 10080)); // 1 –¥–æ 7 –¥–Ω–µ–π    }    private List<String> extractImages(JSONObject main, JSONObject itemObj, JSONObject data) {        List<String> images = new ArrayList<>();        // –ü—É—Ç—å 1: data.picUrl (–≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ)        if (data != null && data.has("picUrl")) {            String picUrl = data.optString("picUrl", "");            if (isValidImageUrl(picUrl)) {                images.add(picUrl);                logger.debug("‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ñ–æ—Ç–æ –≤ data.picUrl");            }        }        // –ü—É—Ç—å 2: data.pics (–º–∞—Å—Å–∏–≤ —Ñ–æ—Ç–æ)        if (data != null && data.has("pics")) {            JSONArray pics = data.optJSONArray("pics");            if (pics != null) {                for (int i = 0; i < Math.min(5, pics.length()); i++) {                    try {                        JSONObject pic = pics.optJSONObject(i);                        if (pic != null) {                            // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –ø–æ–ª—è                            String url = pic.optString("picUrl", "");                            if (url.isEmpty()) {                                url = pic.optString("pic_url", "");                            }                            if (url.isEmpty()) {                                url = pic.optString("url", "");                            }                            if (isValidImageUrl(url) && !images.contains(url)) {                                images.add(url);                                logger.debug("‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ñ–æ—Ç–æ –≤ data.pics[{}]", i);                            }                        }                    } catch (Exception e) {                        logger.debug("Error parsing pic at index {}: {}", i, e.getMessage());                    }                }            }        }        // –ü—É—Ç—å 3: itemObj.extra.picUrl (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ)        if (itemObj != null) {            JSONObject extra = itemObj.optJSONObject("extra");            if (extra != null) {                String picUrl = extra.optString("picUrl", "");                if (picUrl.isEmpty()) {                    picUrl = extra.optString("pic_url", "");                }                if (isValidImageUrl(picUrl) && !images.contains(picUrl)) {                    images.add(picUrl);                    logger.debug("‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ñ–æ—Ç–æ –≤ itemObj.extra.picUrl");                }            }        }        // –ü—É—Ç—å 4: main.exContent.picUrl (–∏—Å—Ö–æ–¥–Ω–æ–µ —Ñ–æ—Ç–æ)        if (main != null) {            JSONObject exContent = main.optJSONObject("exContent");            if (exContent != null) {                String picUrl = exContent.optString("picUrl", "");                if (picUrl.isEmpty()) {                    picUrl = exContent.optString("pic_url", "");                }                if (isValidImageUrl(picUrl) && !images.contains(picUrl)) {                    images.add(picUrl);                    logger.debug("‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ñ–æ—Ç–æ –≤ main.exContent.picUrl");                }            }        }        // –ü—É—Ç—å 5: –ü—Ä—è–º—ã–µ –ø–æ–ª—è –æ–±—ä–µ–∫—Ç–∞ (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —É–ø—Ä–æ—â–µ–Ω–∞)        if (data != null) {            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä—è–º—ã–µ –ø–æ–ª—è –≤ data            String directPic = data.optString("image", "");            if (directPic.isEmpty()) {                directPic = data.optString("img", "");            }            if (isValidImageUrl(directPic) && !images.contains(directPic)) {                images.add(directPic);                logger.debug("‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ñ–æ—Ç–æ –≤ data.image");            }        }        if (images.isEmpty()) {            logger.debug("‚ö†Ô∏è –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è —Ç–æ–≤–∞—Ä–∞");        } else {            logger.debug("üì∑ –ù–∞–π–¥–µ–Ω–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π: {}", images.size());        }        return images;    }    private boolean isValidImageUrl(String url) {        if (url == null || url.isEmpty()) {            return false;        }        // –î–æ–ª–∂–Ω–æ –±—ã—Ç—å HTTPS –∏–ª–∏ HTTP        if (!url.startsWith("http://") && !url.startsWith("https://")) {            return false;        }        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞        String lowerUrl = url.toLowerCase();        String[] validExtensions = {".jpg", ".jpeg", ".png", ".gif", ".webp", ".heic"};        boolean hasValidExtension = false;        for (String ext : validExtensions) {            if (lowerUrl.contains(ext)) {                hasValidExtension = true;                break;            }        }        // –ï—Å–ª–∏ –Ω–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è - –º–æ–∂–µ—Ç –±—ã—Ç—å OK (CDN —Å query parameters)        if (!hasValidExtension && (lowerUrl.contains("alicdn") || lowerUrl.contains("taobaocdn"))) {            return true;        }        return hasValidExtension;    }    private boolean isValidProduct(Product product) {        return product.getId() != null && !product.getId().isEmpty() &&                product.getTitle() != null && !product.getTitle().isEmpty() &&                product.getUrl() != null && !product.getUrl().isEmpty();    }    private String getTokenFromCookies() {        try {            String cookies = CookieService.getCookieHeader("h5api.m.goofish.com");            if (cookies == null || cookies.isEmpty()) return "";            String[] pairs = cookies.split("; ");            for (String pair : pairs) {                if (pair.startsWith("_m_h5_tk=")) {                    String mh5tk = pair.substring(9);                    if (mh5tk.contains("_")) {                        return mh5tk.split("_")[0];                    }                }            }        } catch (Exception e) {            logger.warn("Error getting token: {}", e.getMessage());        }        return "";    }    private String generateSignature(String token, long timestamp, String data) {        try {            String signString = token + "&" + timestamp + "&" + APP_KEY + "&" + data;            MessageDigest md = MessageDigest.getInstance("MD5");            byte[] hash = md.digest(signString.getBytes(StandardCharsets.UTF_8));            StringBuilder hex = new StringBuilder();            for (byte b : hash) {                String h = Integer.toHexString(0xff & b);                if (h.length() == 1) hex.append('0');                hex.append(h);            }            return hex.toString();        } catch (Exception e) {            logger.error("Error generating signature: {}", e.getMessage());            return "";        }    }    /**     * –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ search –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è POST –∑–∞–ø—Ä–æ—Å–æ–≤     */    @Override    public List<Product> search(String query, int maxPages, int rowsPerPage, int maxAgeMinutes) {        List<Product> allProducts = new ArrayList<>();        logger.info("Starting search: site={}, query='{}', pages={}, rows={}, maxAge={}min",                siteName, query, maxPages, rowsPerPage, maxAgeMinutes);        for (int page = 1; page <= maxPages; page++) {            if (Thread.currentThread().isInterrupted()) break;            try {                // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è API                String url = buildSearchUrl(query, page, rowsPerPage);                if (url.isEmpty()) {                    logger.error("Failed to build URL for page {}", page);                    break;                }                // –í—ã–ø–æ–ª–Ω—è–µ–º POST –∑–∞–ø—Ä–æ—Å                String response = executeSearchRequest(url, query, page, rowsPerPage);                totalRequests++;                // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç                List<Product> products = parseResponse(response, query);                if (products.isEmpty()) {                    logger.debug("No products on page {}", page);                    break;                }                // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É                List<Product> filtered = new ArrayList<>();                for (Product p : products) {                    if (p.getAgeMinutes() <= maxAgeMinutes) {                        filtered.add(p);                    }                }                allProducts.addAll(filtered);                logger.info("Page {}: found {} products ({} after age filter)",                        page, products.size(), filtered.size());                // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –µ—Å–ª–∏ –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä —Ä–µ–∂–µ—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞—Ä—É –ø—Ä–∏–º–µ—Ä–æ–≤ (INFO),                // —á—Ç–æ–±—ã –±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ, –ø–æ—á–µ–º—É ‚Äú–Ω–∞ —Å–∞–π—Ç–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ, –∞ —É –Ω–∞—Å –∏—Ö –º–∞–ª–æ‚Äù.                if (products.size() > 0 && filtered.size() < products.size()) {                    int removed = products.size() - filtered.size();                    if (filtered.isEmpty() || removed >= Math.max(5, products.size() / 2)) {                        StringBuilder dbg = new StringBuilder();                        dbg.append("Age filter removed ").append(removed)                                .append(" of ").append(products.size())                                .append(" (maxAgeMinutes=").append(maxAgeMinutes).append("). Examples: ");                        int shown = 0;                        for (Product p : products) {                            if (p.getAgeMinutes() > maxAgeMinutes) {                                dbg.append(p.getId()).append("(age=").append(p.getAgeMinutes()).append("m)");                                shown++;                                if (shown >= 5) break;                                dbg.append(", ");                            }                        }                        logger.info(dbg.toString());                    }                }                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ API —Ä–µ–∞–ª—å–Ω–æ –≤–µ—Ä–Ω—É–ª–æ –º–µ–Ω—å—à–µ rowsPerPage.                // –ò–Ω–∞—á–µ –º–æ–∂–µ–º –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –∏–∑-–∑–∞ –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ –∏ –Ω–µ –¥–æ–±—Ä–∞—Ç—å —Ç–æ–≤–∞—Ä—ã.                if (products.size() < rowsPerPage) break;                // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏                int delay = getRequestDelay();                if (delay > 0 && page < maxPages) {                    Thread.sleep(delay);                }            } catch (Exception e) {                failedRequests++;                logger.error("Error on page {}: {}", page, e.getMessage());                if (shouldStopOnError(e)) break;                try {                    Thread.sleep(3000);                } catch (InterruptedException ie) {                    Thread.currentThread().interrupt();                    break;                }            }        }        logger.info("Search completed: found {} products in {} requests",                allProducts.size(), totalRequests);        return allProducts;    }}